<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Funke AI - Learning Console</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>
    <!-- Google Sign-In API -->
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* ---------------------
           GENERAL/BODY
        ----------------------*/
        body {
            background: linear-gradient(135deg, #E9F3FF 0%, #FAFAFA 100%);
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            color: #333;
        }

        /* ---------------------
           HEADER
        ----------------------*/
        .header {
            background: #ffffff;
            color: #333;
            padding: 10px 20px;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #ddd;
        }
        .header-left,
        .header-center,
        .header-right {
            display: flex;
            align-items: center;
        }
        .header-center {
            flex: 1;
            justify-content: center;
        }
        .header img {
            height: 52px;
            margin-right: 10px;
        }
        .header h1 {
            margin: 0;
            font-size: 1.5rem;
        }

        /* Saved message styling (green bubble) */
        .save-message {
            display: none;
            background: #28a745;
            color: white;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            transition: opacity 0.5s ease-in-out;
            position: absolute;
            right: 20px;
            top: 10px;
            opacity: 0;
        }

        /* ---------------------
           SPACER
        ----------------------*/
        .spacer {
            height: 60px;
        }

        /* ---------------------
           LOGIN CONTAINER
        ----------------------*/
        #loginContainer {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        /* Responsive styling for the login image */
        #loginContainer img {
            width: 180px;
            height: 154px;
            max-width: 50%;
            margin-bottom: 20px;
        }
        /* Center the Google Sign-In button */
        .g_id_signin {
            margin: 0 auto;
        }
        #appContent {
            display: none;
        }

        /* ---------------------
           USER PROFILE
        ----------------------*/
        .user-profile {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        .user-profile img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* ---------------------
           SIDEBAR
        ----------------------*/
        .notebook-sidebar {
            background: #ffffff;
            padding: 20px;
            border-radius: 10px;
            color: #333;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .notebook-sidebar h4 {
            font-weight: bold;
            color: #333;
        }
        .notebook-item {
            cursor: pointer;
            padding: 10px;
            margin: 5px 0;
            border-radius: 8px;
            transition: background-color 0.2s;
            background-color: #F7FAFD;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .notebook-item span {
            flex: 1;
        }
        .notebook-item:hover {
            background-color: #D2BBFF;
        }
        .notebook-item.active {
            background-color: #D2BBFF;
            font-weight: bold;
        }
        .notebook-item button {
            font-size: 12px;
            margin-left: 5px;
        }

        /* ---------------------
           CARD STYLING
        ----------------------*/
        .card {
            background: #ffffff !important;
            border: none;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .card .card-body {
            position: relative;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        /* ---------------------
           BUTTONS
        ----------------------*/
        .btn {
            background-color: #D2BBFF !important;
            border-color: #D2BBFF !important;
            color: #333 !important;
        }
        .btn:hover,
        .btn:focus,
        .btn:active {
            background-color: #D2BBFF !important;
            border-color: #D2BBFF !important;
            color: #333 !important;
        }
        .btn-danger {
            background-color: #F2C7C7 !important;
            border-color: #F2C7C7 !important;
            color: #333 !important;
        }
        .btn-danger:hover,
        .btn-danger:focus,
        .btn-danger:active {
            background-color: #F2C7C7 !important;
            border-color: #F2C7C7 !important;
            color: #333 !important;
        }
        .btn-double {
            padding-left: 2rem !important;
            padding-right: 2rem !important;
        }

        /* ---------------------
           MODERN SELECT DROPDOWN
        ----------------------*/
        .form-select {
            border-radius: 8px !important;
            background-color: #fff !important;
            border: 1px solid #ccc !important;
            color: #333 !important;
            padding: 8px 12px !important;
            font-size: 1rem !important;
        }
        .form-select:focus {
            outline: none !important;
            box-shadow: 0 0 4px rgba(210, 187, 255, 0.5) !important;
            border-color: #D2BBFF !important;
        }

        /* ---------------------
           MODALS
        ----------------------*/
        .modal-content {
            border-radius: 10px;
        }
        .modal-header,
        .modal-footer {
            border: none;
        }
    </style>
</head>
<body>
<div class="header">
    <div class="header-left">
        <img src="funkeai.png" alt="Logo">
    </div>
    <div class="header-center">
        <h1>Funke AI Learning</h1>
    </div>
    <div class="header-right">
        <div id="userProfile" class="user-profile" style="display: none;">
            <img id="userAvatar" src="" alt="User">
            <span id="userName"></span>
        </div>
        <button id="logoutButton" class="btn btn-outline-dark" style="display: none;" onclick="handleSignOut()">Sign Out</button>
        <button id="manageUsersBtn" class="btn btn-outline-dark ms-2" style="display: none;">Manage Users</button>
        <button id="saveButton" class="btn btn-success ms-2" onclick="saveChanges()" style="display: none;">Save Changes</button>
    </div>
    <div id="saveMessage" class="save-message">Saved!</div>
</div>

<!-- Spacer to push content below the fixed header -->
<div class="spacer"></div>

<!-- Updated Login Container -->
<div id="loginContainer">
    <img src="funkeai.png" alt="FunkeAI Logo">
    <h2 class="mb-4">Lets get Funke, please log in</h2>
    <p class="mb-4">Please sign in with your Google account to continue</p>
    <div id="g_id_onload"
         data-client_id="294376282666-lllnj1ro4d5qu3iq21nmmasr16tjije5.apps.googleusercontent.com"
         data-callback="handleCredentialResponse">
    </div>
    <div class="g_id_signin"
         data-type="standard"
         data-size="large"
         data-theme="outline"
         data-text="sign_in_with"
         data-shape="rectangular"
         data-logo_alignment="left">
    </div>
</div>

<!-- App content - hidden until authenticated -->
<div id="appContent" class="container-fluid mt-4">
    <div class="row">
        <!-- Sidebar with notebooks -->
        <div class="col-md-3">
            <div class="notebook-sidebar">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="m-0">Notebooks</h4>
                    <button class="btn btn-sm btn-light" onclick="showNewNotebookModal()">
                        <i class="bi bi-plus"></i> New
                    </button>
                </div>
                <div id="notebookList">
                    <!-- Notebook list will be populated here -->
                </div>
            </div>
        </div>

        <!-- Main content area -->
        <div class="col-md-9">
            <div id="notebookContent" style="opacity:1; transition: opacity 0.5s ease-in-out;">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3 id="currentNotebookName">Select a Notebook</h3>
                    <div>
                        <button id="exportButton" class="btn btn-outline-primary" onclick="exportNotebook()" style="display: none;">
                            Export for Chrome Extension
                        </button>
                    </div>
                </div>

                <!-- Add new item form (renamed to "Add") -->
                <div id="addItemForm" class="mb-4" style="display: none;">
                    <div class="d-flex gap-2">
                        <input type="text" id="newCommand" class="form-control" placeholder="Enter content">
                        <select id="contentType" class="form-select">
                            <option value="Prompt">💬 Prompt</option>
                            <option value="Multimedia">🎬 Multimedia</option>
                            <option value="Quiz">❓ Quiz</option>
                            <option value="Assignment">📝 Assignment</option>
                            <option value="Website">🌐 Website</option>
                        </select>
                        <button class="btn btn-primary btn-lg btn-double" onclick="addItem()">Add</button>
                    </div>
                </div>

                <!-- Section title moved below the add item form -->
                <h4 class="mb-3" style="font-size: 1.25rem;">Learning Experiences</h4>

                <!-- Cards (Learning Experiences) -->
                <div class="row" id="commandList">
                    <!-- Items will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- New Notebook Modal -->
<div class="modal fade" id="newNotebookModal" tabindex="-1" aria-labelledby="newNotebookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="newNotebookModalLabel">Create New Notebook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newNotebookName" class="form-label">Notebook Name</label>
                    <input type="text" class="form-control" id="newNotebookName" placeholder="Enter a name for your notebook">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createNewNotebook()">Create</button>
            </div>
        </div>
    </div>
</div>

<!-- User Registration Modal -->
<div class="modal fade" id="userRegistrationModal" tabindex="-1" aria-labelledby="userRegistrationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userRegistrationModalLabel">Register New Teacher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="teacherEmail" class="form-label">Teacher Email</label>
                    <input type="email" class="form-control" id="teacherEmail" placeholder="Enter email address">
                </div>
                <div id="registrationMessage" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="registerTeacherBtn">Register</button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden manage users button (shown conditionally) -->
<button id="manageUsersBtn" class="btn btn-outline-light ms-2" style="display: none;">Manage Users</button>

<script>
    // Google Auth variables
    let userToken = '';
    let userData = null;

    // App state variables
    let notebooks = [];
    let currentNotebook = null;
    let currentPlaylist = [];

    // API endpoints
    // const API_BASE_URL = 'https://funkeai.uc.r.appspot.com/api';
    const API_BASE_URL = 'http://localhost:8080/api';

    // Fade animation helper for notebookContent
    function fadeNotebookContent(callback) {
        const container = document.getElementById('notebookContent');
        container.style.transition = "opacity 0.5s ease-in-out";
        container.style.opacity = 0;
        setTimeout(() => {
            callback();
            container.style.opacity = 1;
        }, 500);
    }

    // Check for authentication on page load
    document.addEventListener('DOMContentLoaded', function() {
        const storedAuthData = localStorage.getItem('authData');
        if (storedAuthData) {
            try {
                const authData = JSON.parse(storedAuthData);
                if (authData.token && authData.expiry > Date.now()) {
                    userToken = authData.token;
                    userData = authData.user;
                    document.getElementById('userAvatar').src = userData.picture;
                    document.getElementById('userName').textContent = userData.name;
                    document.getElementById('userProfile').style.display = 'flex';
                    document.getElementById('logoutButton').style.display = 'block';
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('appContent').style.display = 'block';
                    fetchNotebooks();
                    return;
                }
            } catch (error) {
                console.error('Error parsing stored auth data:', error);
            }
            localStorage.removeItem('authData');
        }
        document.getElementById('loginContainer').style.display = 'block';
        document.getElementById('appContent').style.display = 'none';
    });

    async function handleFirstLogin() {
        try {
            const response = await fetch(`${API_BASE_URL}/first-user`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${userToken}`
                }
            });
            if (!response.ok) {
                const data = await response.json();
                if (response.status === 403) {
                    alert('You are not authorized to access this application. Please contact an administrator.');
                    handleSignOut();
                    return false;
                }
            }
            return true;
        } catch (error) {
            console.error('Error handling first login:', error);
            return false;
        }
    }

    function parseJwt(token) {
        const base64Url = token.split('.')[1];
        const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
        const jsonPayload = decodeURIComponent(
            atob(base64)
                .split('')
                .map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2))
                .join('')
        );
        return JSON.parse(jsonPayload);
    }

    async function handleCredentialResponse(response) {
        userToken = response.credential;
        const decodedToken = parseJwt(userToken);
        userData = {
            name: decodedToken.name,
            email: decodedToken.email,
            picture: decodedToken.picture
        };
        const isAuthorized = await handleFirstLogin();
        if (!isAuthorized) return;
        const expiry = decodedToken.exp * 1000;
        localStorage.setItem('authData', JSON.stringify({
            token: userToken,
            user: userData,
            expiry: expiry
        }));
        document.getElementById('userAvatar').src = userData.picture;
        document.getElementById('userName').textContent = userData.name;
        document.getElementById('userProfile').style.display = 'flex';
        document.getElementById('logoutButton').style.display = 'block';
        document.getElementById('loginContainer').style.display = 'none';
        document.getElementById('appContent').style.display = 'block';
        fetchNotebooks();
    }

    function handleSignOut() {
        google.accounts.id.disableAutoSelect();
        userData = null;
        userToken = '';
        localStorage.removeItem('authData');
        document.getElementById('userProfile').style.display = 'none';
        document.getElementById('logoutButton').style.display = 'none';
        document.getElementById('appContent').style.display = 'none';
        document.getElementById('loginContainer').style.display = 'block';
    }

    document.addEventListener('DOMContentLoaded', function() {
        if (localStorage.getItem('authData')) {
            document.getElementById('manageUsersBtn').style.display = 'block';
        }
    });

    document.addEventListener('DOMContentLoaded', function() {
        const manageUsersBtn = document.getElementById('manageUsersBtn');
        if (manageUsersBtn) {
            manageUsersBtn.addEventListener('click', showUserRegistrationModal);
        }
        const registerTeacherBtn = document.getElementById('registerTeacherBtn');
        if (registerTeacherBtn) {
            registerTeacherBtn.addEventListener('click', registerNewTeacher);
        }
    });

    function showUserRegistrationModal() {
        const modal = new bootstrap.Modal(document.getElementById('userRegistrationModal'));
        const emailInput = document.getElementById('teacherEmail');
        if (emailInput) emailInput.value = '';
        const messageElement = document.getElementById('registrationMessage');
        if (messageElement) {
            messageElement.style.display = 'none';
            messageElement.textContent = '';
            messageElement.className = 'alert';
        }
        modal.show();
    }

    async function registerNewTeacher() {
        const emailInput = document.getElementById('teacherEmail');
        const messageElement = document.getElementById('registrationMessage');
        messageElement.style.display = 'none';
        messageElement.textContent = '';
        const email = emailInput.value.trim();
        if (!email || !email.includes('@')) {
            messageElement.textContent = 'Please enter a valid email address.';
            messageElement.className = 'alert alert-danger';
            messageElement.style.display = 'block';
            return;
        }
        try {
            const authData = JSON.parse(localStorage.getItem('authData'));
            if (!authData || !authData.token) {
                throw new Error('You must be logged in to register teachers.');
            }
            const response = await fetch(`${API_BASE_URL}/users/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authData.token}`
                },
                body: JSON.stringify({ email, role: 'teacher' })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to register teacher.');
            }
            messageElement.textContent = 'Teacher registered successfully!';
            messageElement.className = 'alert alert-success';
            messageElement.style.display = 'block';
            emailInput.value = '';
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('userRegistrationModal')).hide();
            }, 2000);
        } catch (error) {
            messageElement.textContent = error.message;
            messageElement.className = 'alert alert-danger';
            messageElement.style.display = 'block';
            console.error('Registration error:', error);
        }
    }

    async function fetchNotebooks() {
        try {
            const response = await fetch(`${API_BASE_URL}/notebooks`, {
                headers: { 'Authorization': `Bearer ${userToken}` }
            });
            if (!response.ok) {
                if (response.status === 404) {
                    notebooks = [];
                    displayNotebooks();
                    return;
                }
                throw new Error('Failed to fetch notebooks.');
            }
            const data = await response.json();
            notebooks = data.notebooks || [];
            displayNotebooks();
        } catch (error) {
            console.error(error);
            alert('Error fetching notebooks: ' + error.message);
        }
    }

    function displayNotebooks() {
        const notebookList = document.getElementById('notebookList');
        notebookList.innerHTML = '';
        if (notebooks.length === 0) {
            notebookList.innerHTML = `
          <div class="text-center p-3">
              <p>No notebooks found.</p>
              <p>Create your first notebook to get started!</p>
          </div>
        `;
            return;
        }
        notebooks.forEach(notebook => {
            const notebookItem = document.createElement('div');
            notebookItem.className = 'notebook-item d-flex align-items-center';
            const nameSpan = document.createElement('span');
            nameSpan.textContent = "📗 " + notebook.name;
            nameSpan.style.cursor = 'pointer';
            nameSpan.onclick = () => selectNotebook(notebook);
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'btn btn-sm btn-danger';
            deleteBtn.innerHTML = '&times;';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteNotebook(notebook);
            };
            notebookItem.appendChild(nameSpan);
            notebookItem.appendChild(deleteBtn);
            if (currentNotebook && notebook.name === currentNotebook.name) {
                notebookItem.classList.add('active');
            }
            notebookList.appendChild(notebookItem);
        });
    }

    async function deleteNotebook(notebook) {
        if (!confirm(`Are you sure you want to delete "${notebook.name}"?`)) {
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/notebooks/${notebook.id || notebook.name}`, {
                method: 'DELETE',
                headers: { 'Authorization': `Bearer ${userToken}` }
            });
            if (!response.ok) {
                throw new Error('Failed to delete notebook');
            }
            notebooks = notebooks.filter(n => n.name !== notebook.name);
            if (currentNotebook && currentNotebook.name === notebook.name) {
                currentNotebook = null;
                currentPlaylist = [];
                document.getElementById('currentNotebookName').textContent = 'Select a Notebook';
                document.getElementById('addItemForm').style.display = 'none';
                document.getElementById('exportButton').style.display = 'none';
                document.getElementById('commandList').innerHTML = '';
            }
            displayNotebooks();
        } catch (error) {
            console.error('Error deleting notebook:', error);
            alert('Error deleting notebook: ' + error.message);
        }
    }

    function selectNotebook(notebook) {
        fadeNotebookContent(() => {
            currentNotebook = notebook;
            currentPlaylist = notebook.playlist || [];
            document.getElementById('currentNotebookName').textContent = notebook.name;
            document.getElementById('addItemForm').style.display = 'block';
            document.getElementById('exportButton').style.display = 'block';
            displayItems(currentPlaylist);
            const notebookItems = document.querySelectorAll('.notebook-item');
            notebookItems.forEach(item => {
                item.classList.remove('active');
                if (item.textContent.replace('×','').trim().includes(notebook.name)) {
                    item.classList.add('active');
                }
            });
        });
    }

    function showNewNotebookModal() {
        const modal = new bootstrap.Modal(document.getElementById('newNotebookModal'));
        modal.show();
    }

    async function createNewNotebook() {
        const notebookName = document.getElementById('newNotebookName').value.trim();
        if (!notebookName) {
            alert('Please enter a notebook name.');
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/notebooks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                },
                body: JSON.stringify({ name: notebookName, playlist: [] })
            });
            if (!response.ok) {
                throw new Error('Failed to create notebook.');
            }
            bootstrap.Modal.getInstance(document.getElementById('newNotebookModal')).hide();
            document.getElementById('newNotebookName').value = '';
            await fetchNotebooks();
            const newNotebook = notebooks.find(n => n.name === notebookName);
            if (newNotebook) {
                selectNotebook(newNotebook);
            }
        } catch (error) {
            console.error(error);
            alert('Error creating notebook: ' + error.message);
        }
    }

    function generateUniqueId() {
        return 'id-' + Math.random().toString(36).substr(2, 9);
    }

    function displayItems(items) {
        const list = document.getElementById('commandList');
        list.innerHTML = '';
        if (!items || items.length === 0) {
            list.innerHTML = `
          <div class="col-12">
              <div class="alert alert-info">
                  This notebook is empty. Add your first learning experience above!
              </div>
          </div>
        `;
            return;
        }
        items.forEach((item, index) => {
            const card = document.createElement('div');
            card.className = 'col-md-4 mb-3';
            card.setAttribute('data-index', index);
            card.innerHTML = `
          <div class="card">
              <div class="card-body">
                  <select class="form-select mb-2" onchange="updateType(${index}, this.value)">
                      <option value="Prompt" ${item.type === 'Prompt' ? 'selected' : ''}>💬 Prompt</option>
                      <option value="Multimedia" ${item.type === 'Multimedia' ? 'selected' : ''}>🎬 Multimedia</option>
                      <option value="Quiz" ${item.type === 'Quiz' ? 'selected' : ''}>❓ Quiz</option>
                      <option value="Assignment" ${item.type === 'Assignment' ? 'selected' : ''}>📝 Assignment</option>
                      <option value="Website" ${item.type === 'Website' ? 'selected' : ''}>🌐 Website</option>
                  </select>
                  <textarea class="form-control mb-2" rows="3" onchange="editItem(${index}, this.value)">${item.command}</textarea>
                  <button class="btn btn-danger btn-sm" onclick="removeItem(${index})">Remove</button>
              </div>
          </div>`;
            list.appendChild(card);
        });
        new Sortable(list, {
            animation: 150,
            onEnd: function (evt) {
                const [movedItem] = currentPlaylist.splice(evt.oldIndex, 1);
                currentPlaylist.splice(evt.newIndex, 0, movedItem);
                displayItems(currentPlaylist);
                showSaveButton();
            }
        });
    }

    function addItem() {
        if (!currentNotebook) {
            alert('Please select or create a notebook first.');
            return;
        }
        const newCommand = document.getElementById('newCommand').value;
        const contentType = document.getElementById('contentType').value;
        if (!newCommand.trim()) return;
        currentPlaylist.push({
            id: generateUniqueId(),
            command: newCommand,
            type: contentType || 'Prompt'
        });
        displayItems(currentPlaylist);
        document.getElementById('newCommand').value = '';
        showSaveButton();
    }

    function showSaveButton() {
        document.getElementById('saveButton').style.display = 'block';
    }

    function editItem(index, value) {
        currentPlaylist[index].command = value;
        showSaveButton();
    }

    function updateType(index, value) {
        currentPlaylist[index].type = value;
        showSaveButton();
    }

    function removeItem(index) {
        currentPlaylist.splice(index, 1);
        displayItems(currentPlaylist);
        showSaveButton();
    }

    async function saveChanges() {
        if (!currentNotebook) {
            alert('Please select or create a notebook first.');
            return;
        }
        try {
            const response = await fetch(`${API_BASE_URL}/notebooks`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${userToken}`
                },
                body: JSON.stringify({
                    name: currentNotebook.name,
                    playlist: currentPlaylist
                })
            });
            if (!response.ok) {
                throw new Error('Failed to save changes to database.');
            }
            const notebookIndex = notebooks.findIndex(n => n.name === currentNotebook.name);
            if (notebookIndex !== -1) {
                notebooks[notebookIndex].playlist = currentPlaylist;
            }
            document.getElementById('saveButton').style.display = 'none';
            const saveMsg = document.getElementById('saveMessage');
            saveMsg.style.display = 'block';
            saveMsg.style.opacity = '1';
            setTimeout(() => {
                saveMsg.style.opacity = '0';
                setTimeout(() => {
                    saveMsg.style.display = 'none';
                }, 500);
            }, 2000);
        } catch (error) {
            console.error(error);
            alert('Error saving changes: ' + error.message);
        }
    }

    function exportNotebook() {
        if (!currentNotebook) {
            alert('Please select a notebook first.');
            return;
        }
        try {
            const notebookData = {
                name: currentNotebook.name,
                playlist: currentPlaylist
            };
            const blob = new Blob([JSON.stringify(notebookData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentNotebook.name.replace(/\s+/g, '_')}.json`;
            document.body.appendChild(a);
            a.click();
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }, 0);
        } catch (error) {
            console.error(error);
            alert('Error exporting notebook: ' + error.message);
        }
    }

    window.onload = function() {
        google.accounts.id.initialize({
            client_id: "",
            callback: handleCredentialResponse
        });
        google.accounts.id.renderButton(
            document.getElementById("g_id_signin"),
            { theme: "outline", size: "large" }
        );
    };
</script>
</body>
</html>
